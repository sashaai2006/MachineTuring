# Makefile –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –ú–∞—à–∏–Ω—ã –¢—å—é—Ä–∏–Ω–≥–∞
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—É—é –º–æ–¥—É–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏

# –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –∏ —Ñ–ª–∞–≥–∏
CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -pedantic -O2 -g

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
SRC_DIR = .
OBJ_DIR = obj
BIN_DIR = bin

# –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
SOURCES = $(wildcard $(SRC_DIR)/*.cpp)
OBJECTS = $(SOURCES:$(SRC_DIR)/%.cpp=$(OBJ_DIR)/%.o)

# –ó–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã (–¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)
HEADERS = \
	SmartPtrs.h \
	StatisticsManager.h \
	TransitionManager.h \
	StateManager.h \
	TuringStrip.h \
	HeadManager.h \
	MT.h \
	LazySeq.h \
	Gen.h \
	Mem.h

# –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å
TARGET = $(BIN_DIR)/turing_machine

# –¶–µ–ª—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
TEST_TARGET = $(BIN_DIR)/test_turing

# –í—Å–µ —Ü–µ–ª–∏
.PHONY: all clean test run help debug release install

# –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞
all: $(TARGET)

# –°–æ–∑–¥–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
$(TARGET): $(OBJECTS) | $(BIN_DIR)
	@echo "üîó –°–±–æ—Ä–∫–∞ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞..."
	$(CXX) $(OBJECTS) -o $@
	@echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $@"

# –ü—Ä–∞–≤–∏–ª–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.cpp $(HEADERS) | $(OBJ_DIR)
	@echo "üîß –ö–æ–º–ø–∏–ª—è—Ü–∏—è $<..."
	$(CXX) $(CXXFLAGS) -c $< -o $@

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
$(OBJ_DIR):
	@mkdir -p $(OBJ_DIR)

$(BIN_DIR):
	@mkdir -p $(BIN_DIR)

# –û—á–∏—Å—Ç–∫–∞
clean:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å–±–æ—Ä–∫–∏..."
	@rm -rf $(OBJ_DIR) $(BIN_DIR)
	@echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã
run: $(TARGET)
	@echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã..."
	@./$(TARGET)

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã)
test: $(TEST_TARGET)
	@echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
	@./$(TEST_TARGET)

# –°–±–æ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å test.cpp)
$(TEST_TARGET): $(filter-out $(OBJ_DIR)/main.o, $(OBJECTS)) $(OBJ_DIR)/test.o | $(BIN_DIR)
	@echo "üîó –°–±–æ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤..."
	$(CXX) $^ -o $@
	@echo "‚úÖ –¢–µ—Å—Ç—ã —Å–æ–±—Ä–∞–Ω—ã: $@"

# –°–±–æ—Ä–∫–∞ –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏
debug: CXXFLAGS += -DDEBUG -O0 -g3
debug: clean $(TARGET)
	@echo "üêõ –°–±–æ—Ä–∫–∞ –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –†–µ–ª–∏–∑–Ω–∞—è —Å–±–æ—Ä–∫–∞
release: CXXFLAGS += -DNDEBUG -O3 -s
release: clean $(TARGET)
	@echo "üöÄ –†–µ–ª–∏–∑–Ω–∞—è —Å–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
install: $(HEADERS)
	@echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
	@mkdir -p /usr/local/include/turing_machine
	@cp $(HEADERS) /usr/local/include/turing_machine/
	@echo "‚úÖ –ó–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ /usr/local/include/turing_machine/"

# –ü–æ–º–æ—â—å
help:
	@echo "üéØ –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ü–µ–ª–∏:"
	@echo "  all      - –°–æ–±—Ä–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
	@echo "  clean    - –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã —Å–±–æ—Ä–∫–∏"
	@echo "  run      - –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É"
	@echo "  test     - –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã"
	@echo "  debug    - –°–æ–±—Ä–∞—Ç—å –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏"
	@echo "  release  - –°–æ–±—Ä–∞—Ç—å —Ä–µ–ª–∏–∑–Ω—É—é –≤–µ—Ä—Å–∏—é"
	@echo "  install  - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã"
	@echo "  help     - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
	@echo ""
	@echo "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤:"
	@echo "  –ó–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–µ: $(HEADERS)"
	@echo "  –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π:  $(TARGET)"
	@echo "  –¢–µ—Å—Ç—ã:        $(TEST_TARGET)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∫–æ–¥–∞ (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω clang-format)
format:
	@echo "‚ú® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞..."
	@find . -name '*.h' -o -name '*.cpp' | xargs clang-format -i
	@echo "‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"

# –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω cppcheck)
analyze:
	@echo "üîç –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞..."
	@cppcheck --enable=all --std=c++17 $(SRC_DIR)
	@echo "‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω"

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–µ
info:
	@echo "‚ÑπÔ∏è  –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–±–æ—Ä–∫–µ:"
	@echo "  –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä: $(CXX)"
	@echo "  –§–ª–∞–≥–∏:      $(CXXFLAGS)"
	@echo "  –ò—Å—Ö–æ–¥–Ω–∏–∫–∏:  $(SOURCES)"
	@echo "  –û–±—ä–µ–∫—Ç—ã:    $(OBJECTS)"
	@echo "  –¶–µ–ª—å:       $(TARGET)"

# –ë—ã—Å—Ç—Ä–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ (—Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã)
rebuild: clean all

# –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –ø—Ä–æ–µ–∫—Ç–∞
archive:
	@echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
	@tar -czf turing_machine_$(shell date +%Y%m%d).tar.gz *.h *.cpp Makefile README.md 2>/dev/null || true
	@echo "‚úÖ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: turing_machine_$(shell date +%Y%m%d).tar.gz"

# –¶–µ–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Å–æ–∑–¥–∞—é—Ç —Ñ–∞–π–ª—ã
.PHONY: format analyze info rebuild archive